name: Validate Rulesync

on:
  pull_request:
    paths:
      - rulesync.jsonc
      - rulesync.lock
      - package.json
      - package-lock.json
      - .rulesync/**
      - .github/workflows/validate-rulesync.yml
  push:
    branches:
      - master
    paths:
      - rulesync.jsonc
      - rulesync.lock
      - package.json
      - package-lock.json
      - .rulesync/**
      - .github/workflows/validate-rulesync.yml

jobs:
  validate-rulesync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GITHUB_TOKEN: ${{ secrets.RULESYNC_GITHUB_TOKEN || github.token }}
      GH_TOKEN: ${{ secrets.RULESYNC_GITHUB_TOKEN || github.token }}
      SKIP_SIMPLE_GIT_HOOKS: '1'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Regenerate rulesync outputs
        run: |
          npx rulesync generate --delete

      - name: Check generated-file drift
        shell: bash
        run: |
          if ! git diff --quiet; then
            echo "::error::rulesync output drift detected after regeneration"
            echo "Run: npx rulesync generate --delete"
            echo "If lock refresh is intended, run: npm run rulesync:update"
            git --no-pager diff --name-only
            exit 1
          fi
