name: Reusable Copilot Setup Job

on:
  workflow_call:
    inputs:
      runner-label:
        description: Runner label to execute setup on.
        required: false
        type: string
        default: copilot-devenv-runner
      activation-script-path:
        description: Path to pre-baked activation script on the runner image.
        required: false
        type: string
        default: /home/runner/copilot-devenv-activate.sh
      required-artifact-file:
        description: Repository file that must exist as part of setup validation.
        required: false
        type: string
        default: rulesync.jsonc
      summary-workflow-path:
        description: Workflow path shown in job summary output.
        required: false
        type: string
        default: .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ${{ inputs.runner-label }}
    timeout-minutes: 15
    env:
      GITHUB_TOKEN: ${{ secrets.RULESYNC_GITHUB_TOKEN || github.token }}
      GH_TOKEN: ${{ secrets.RULESYNC_GITHUB_TOKEN || github.token }}
      SKIP_SIMPLE_GIT_HOOKS: '1'
      RUNNER_LABEL: ${{ inputs.runner-label }}
      ACTIVATION_SCRIPT_PATH: ${{ inputs.activation-script-path }}
      REQUIRED_ARTIFACT_FILE: ${{ inputs.required-artifact-file }}
      SUMMARY_WORKFLOW_PATH: ${{ inputs.summary-workflow-path }}

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      actions: read
      # If you want to clone the repository as part of your setup steps, for example to install dependencies, you'll need the `contents: read` permission. If you don't clone the repository in your setup steps, Copilot will do this for you automatically after the steps complete.
      contents: read

    # You can define any steps you want, and they will run before the agent starts.
    # If you do not check out your code, Copilot will do this for you.
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          clean: false

      - name: Activate pre-baked devenv environment
        id: activate_devenv
        uses: ./.github/actions/setup-devenv
        with:
          mode: auto
          activation_script_path: ${{ inputs.activation-script-path }}
          verify_files: ${{ inputs.required-artifact-file }}
          verify_commands: |
            devenv
            node
            python3
            jq
          runner_label_hint: ${{ inputs.runner-label }}

      - name: Write setup summary
        if: always()
        uses: ./.github/actions/devenv-summary
        with:
          mode: setup
          workflow_name: Copilot Setup Steps
          workflow_path: ${{ inputs.summary-workflow-path }}
          github_token: ${{ github.token }}
          runner_label: ${{ inputs.runner-label }}
          activation_mode: ${{ steps.activate_devenv.outputs.activation_mode }}
          activation_seconds: ${{ steps.activate_devenv.outputs.activation_seconds }}
          verification_status: ${{ steps.activate_devenv.outputs.verification_status }}
